<!--
Stacks its child elements on top of each other, taking on the maximum height
and width of the child elements.
-->

<link rel="import" href="../basic-element/basic-element.html">

<polymer-element name="basic-stack" extends="basic-element">
<template>
  <style>
  :host {
    background: rgba( 0, 128, 128, 0.2 );
    /*border: 1px solid rgba( 255, 0, 0, .5 );*/
    /*box-sizing: border-box;*/
    display: block;
    position: relative;
  }

  #measureContainer {
    left: 0;
    position: absolute;
    top: 0;
    width: 100%;
  }

  polyfill-next-selector {
    content: '#measureContainer > *';
  }
  ::content > * {
    position: absolute;
  }
  </style>
  <div id="measureContainer">
    <content id="content"></content>
  </div>
</template>
<script>
Polymer({

  attached: function() {
    this.super();
    window.addEventListener( "resize", this._resizeHandler );
  },

  // TODO: Come up with some way to monitor attributes in contentChanged.
  // BUG: Don't trigger contentChanged if mutation is on the element itself --
  // should only trigger on changes in the tree of nodes below this element.
  contentChanged: function() {
    setTimeout( function() {
      this.recalc();    
    }.bind( this ));
  },

  detached: function() {
    this.super();
    window.removeEventListener( "resize", this._resizeHandler );
  },

  ready: function() {
    this.super();
    this._resizeHandler = this._resize.bind( this );
  },

  recalc: function() {
    var contentNodes = this.flattenChildren;
    var maxWidth = 0;
    var maxHeight = 0;
    Array.prototype.forEach.call( contentNodes, function( node ) {
      if ( node.offsetWidth ) {
        maxWidth = Math.max( maxWidth, node.offsetWidth );
      }
      if ( node.offsetHeight ) {
        maxHeight = Math.max( maxHeight, node.offsetHeight );
      }
    });
    maxWidth = Math.ceil( maxWidth ); // Round up to avoid layout problems.
    var width = maxWidth
      ? maxWidth + "px"
      : null;
    var height = maxHeight
      ? maxHeight + "px"
      : null;
    if ( this.style.width !== width ) {
      this.style.width = width;
    }
    if ( this.style.height !== height ) {
      this.style.height = height;    
    }

    var event = new CustomEvent( "basic-stack-resize", {
      detail: {
        count: contentNodes.length,
        height: parseInt( height ),
        width: parseInt( width )
      }
    });
    this.dispatchEvent( event );
  },

  _resize: function( event ) {
    this.style.width = null;
    this.recalc();    
  },

  _resizeHandler: null

});
</script>
</polymer-element>
